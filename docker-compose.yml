version: "3"

services:
  redis:
    image: redis:latest
    command: redis-server --appendonly yes --requirepass redispass
    volumes:
      - ./volumes/redis:/data

  clickhouse:
    image: "yandex/clickhouse-server:latest"
    volumes:
      - "./volumes/clickhouse:/var/lib/clickhouse"
    ulimits:
      nofile:
        soft: "262144"
        hard: "262144"

  minio:
    image: minio/minio:latest
    command: server /data
    volumes:
      - ./volumes/minio:/data
    ports:
      - "9000:9000"

  api:
    build:
      context: .
      dockerfile: ./dockerfiles/Dockerfile-api
    volumes:
      - ./diamond_miner:/app/diamond_miner
    ports:
      - "8000:8000"
    depends_on:
      - clickhouse
      - loki
      - minio
      - redis

  worker:
    build:
      context: .
      dockerfile: ./dockerfiles/Dockerfile-worker
      args:
        DEBUG_ITERATION: 0
    volumes:
      - ./diamond_miner:/app/diamond_miner
    depends_on:
      - clickhouse
      - loki
      - minio
      - redis

  agent:
    build:
      context: .
      dockerfile: ./dockerfiles/Dockerfile-agent
      args:
        DEBUG_ITERATION: 0
    cap_add:
      - SYS_PTRACE
    volumes:
      - ./diamond_miner:/app/diamond_miner
    depends_on:
      - clickhouse
      - loki
      - minio
      - redis

  prometheus:
    image: prom/prometheus:v2.11.1
    volumes:
      - "./volumes/prometheus:/prometheus"
      - "./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=365d"

  loki:
    image: grafana/loki:1.5.0
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - "./volumes/loki:/loki"

  grafana:
    image: grafana/grafana:master
    ports:
      - "3000:3000"
    volumes:
      - "./volumes/graphana:/var/lib/grafana"
